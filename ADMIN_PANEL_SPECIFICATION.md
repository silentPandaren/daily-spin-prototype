# Спецификация админ-панели — Daily Spin Wheel

**Версия:** 1.0  
**Последнее обновление:** 2024  
**Назначение:** Управление конфигурацией колеса фортуны через административную панель

---

## Содержание

1. [Обзор](#обзор)
2. [Разделы админ-панели](#разделы-админ-панели)
3. [Спецификация полей](#спецификация-полей)
4. [Валидация данных](#валидация-данных)
5. [Права доступа](#права-доступа)

---

## Обзор

Админ-панель позволяет администраторам управлять всеми аспектами колеса фортуны без изменения кода:
- Настройка призов и их вероятностей
- Управление Pity Timer
- Привязка купонов к офферам в магазине
- Управление витринами
- Просмотр статистики и аналитики

---

## Разделы админ-панели

1. **Управление витринами** — создание и настройка витрин
2. **Конфигурация призов** — управление призами для каждой витрины
3. **Настройки Pity Timer** — управление гарантированными призами
4. **Привязка купонов** — связь купонов с офферами магазина
5. **Статистика и аналитика** — просмотр метрик и отчетов
6. **История изменений** — аудит изменений конфигурации

---

## Спецификация полей

### Раздел 1: Управление витринами

#### Таблица: Основные настройки витрины

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `showcase_id` | Integer (readonly) | Уникальный идентификатор витрины (автогенерируется) |
| `game_id` | Integer (select/dropdown) | Идентификатор игры, к которой привязана витрина. Список игр загружается из системы управления играми |
| `is_active` | Boolean (checkbox) | Активна ли витрина. Неактивные витрины не отображаются пользователям |
| `showcase_name` | String (text input, max 255) | Название витрины для внутреннего использования (например, "Rush Royale - Main Showcase") |
| `description` | String (textarea, max 1000) | Описание витрины для администраторов |
| `created_at` | DateTime (readonly) | Дата и время создания витрины |
| `updated_at` | DateTime (readonly) | Дата и время последнего обновления |

---

### Раздел 2: Конфигурация призов

#### Таблица: Настройки приза

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `prize_id` | Integer (readonly) | Уникальный идентификатор приза (автогенерируется) |
| `showcase_id` | Integer (readonly/select) | Идентификатор витрины, к которой относится приз |
| `name` | String (text input, max 255, required) | Название приза, отображаемое в модальном окне после выигрыша (например, "Legendary Item", "50 Platinum") |
| `wheel_text` | String (text input, max 255, required) | Текст, отображаемый на секторе колеса. Поддерживает `\n` для переноса строки (например, "50\nPlatinum") |
| `color` | String (color picker, hex format, required) | Цвет сектора колеса в формате HEX (например, `#005aff`, `#642ab5`). Должен быть валидным hex-кодом |
| `icon` | File (image upload, required) | Иконка приза. Форматы: PNG, JPG, SVG. Максимальный размер: 2MB. Рекомендуемый размер: 128x128px или 256x256px. Отображается на колесе и в модальном окне |
| `icon_preview` | Image (readonly) | Предпросмотр загруженной иконки |
| `weight` | Integer (number input, 1-100, required) | Вес вероятности выпадения приза. Должен быть целым числом от 1 до 100. Сумма всех весов активных призов должна равняться 100 |
| `display_order` | Integer (number input, 0-7, required) | Порядок отображения приза на колесе. Должен быть уникальным для каждой витрины. 0 = первый сектор (верхний), 7 = последний |
| `is_active` | Boolean (checkbox) | Активен ли приз. Неактивные призы не участвуют в розыгрыше и не отображаются на колесе |
| `version` | Integer (readonly) | Версия конфигурации (автоматически увеличивается при изменении) |
| `created_at` | DateTime (readonly) | Дата и время создания приза |
| `updated_at` | DateTime (readonly) | Дата и время последнего обновления |

#### Валидация при создании/редактировании приза:
- Сумма всех `weight` активных призов должна равняться 100
- Для каждой витрины должно быть ровно 8 активных призов
- `display_order` должен быть уникальным (0-7) для активных призов витрины
- Иконка должна быть загружена перед сохранением

---

### Раздел 3: Настройки Pity Timer

#### Таблица: Конфигурация Pity Timer

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `showcase_id` | Integer (readonly/select) | Идентификатор витрины, для которой настраивается Pity Timer |
| `legendary_prize_id` | Integer (select/dropdown, required) | ID приза, который гарантируется через Pity Timer. Список формируется из активных призов выбранной витрины |
| `threshold` | Integer (number input, 1-100, required) | Количество спинов без легендарного приза, после которого следующий спин гарантированно даст легендарный приз. По умолчанию: 10 |
| `is_enabled` | Boolean (checkbox) | Включен ли Pity Timer для этой витрины. Если выключен, гарантированные призы не выдаются |
| `updated_at` | DateTime (readonly) | Дата и время последнего обновления настроек |

#### Валидация:
- `legendary_prize_id` должен существовать и быть активным призом для выбранной витрины
- `threshold` должен быть положительным числом (рекомендуется 5-20)

---

### Раздел 4: Привязка купонов к офферам

#### Таблица: Настройки получения купонов

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `offer_id` | Integer (select/dropdown, required) | Идентификатор оффера в магазине, при покупке которого начисляются купоны |
| `offer_name` | String (readonly) | Название оффера (загружается из системы магазина) |
| `coupons_amount` | Integer (number input, 1-100, required) | Количество купонов, начисляемых при покупке этого оффера |
| `showcase_id` | Integer (select/dropdown, required) | Идентификатор витрины, для которой действует эта привязка |
| `is_active` | Boolean (checkbox) | Активна ли привязка. Неактивные привязки не начисляют купоны |
| `valid_from` | DateTime (datetime picker) | Дата и время начала действия привязки. Если не указано, действует с момента создания |
| `valid_until` | DateTime (datetime picker) | Дата и время окончания действия привязки. Если не указано, действует бессрочно |
| `priority` | Integer (number input, 0-100) | Приоритет привязки. Если пользователь покупает несколько офферов одновременно, используется привязка с наивысшим приоритетом |
| `created_at` | DateTime (readonly) | Дата и время создания привязки |
| `updated_at` | DateTime (readonly) | Дата и время последнего обновления |

#### Дополнительные настройки:

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `daily_login_coupons` | Integer (number input, 0-10) | Количество купонов, начисляемых за ежедневный вход. 0 = отключено |
| `first_spin_bonus` | Integer (number input, 0-5) | Бонусные купоны для первого спина нового пользователя. 0 = отключено |
| `referral_coupons` | Integer (number input, 0-10) | Количество купонов за приглашение друга (реферальная программа). 0 = отключено |

---

### Раздел 5: Статистика и аналитика

#### Таблица: Метрики витрины

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `showcase_id` | Integer (select/dropdown) | Выбор витрины для просмотра статистики |
| `date_from` | Date (date picker) | Начальная дата периода для фильтрации статистики |
| `date_to` | Date (date picker) | Конечная дата периода для фильтрации статистики |
| `total_spins` | Integer (readonly) | Общее количество спинов за выбранный период |
| `unique_users` | Integer (readonly) | Количество уникальных пользователей, совершивших спины |
| `total_coupons_spent` | Integer (readonly) | Общее количество потраченных купонов |
| `total_coupons_earned` | Integer (readonly) | Общее количество заработанных купонов |
| `average_spins_per_user` | Float (readonly, 2 decimal places) | Среднее количество спинов на пользователя |
| `pity_wins_count` | Integer (readonly) | Количество призов, выданных через Pity Timer |
| `pity_wins_percentage` | Float (readonly, 2 decimal places) | Процент призов, выданных через Pity Timer от общего количества спинов |

#### Таблица: Распределение призов

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `prize_name` | String (readonly) | Название приза |
| `expected_percentage` | Float (readonly, 2 decimal places) | Ожидаемый процент выпадения (из конфигурации weight) |
| `actual_count` | Integer (readonly) | Фактическое количество выигранных призов за период |
| `actual_percentage` | Float (readonly, 2 decimal places) | Фактический процент выпадения |
| `deviation` | Float (readonly, 2 decimal places) | Отклонение фактического процента от ожидаемого (может быть отрицательным) |

#### Таблица: Топ пользователей

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `user_id` | String (readonly) | Идентификатор пользователя |
| `total_spins` | Integer (readonly) | Общее количество спинов пользователя |
| `legendary_wins` | Integer (readonly) | Количество выигранных легендарных призов |
| `pity_wins` | Integer (readonly) | Количество призов через Pity Timer |
| `last_spin_at` | DateTime (readonly) | Дата и время последнего спина |

---

### Раздел 6: История изменений

#### Таблица: Аудит изменений

| Название поля | Тип данных | Описание |
|---------------|-----------|----------|
| `change_id` | Integer (readonly) | Уникальный идентификатор изменения |
| `entity_type` | String (readonly) | Тип измененной сущности: `showcase`, `prize`, `pity_config`, `coupon_binding` |
| `entity_id` | Integer (readonly) | ID измененной сущности |
| `admin_user_id` | Integer (readonly) | ID администратора, внесшего изменение |
| `admin_username` | String (readonly) | Имя пользователя администратора |
| `action` | String (readonly) | Действие: `create`, `update`, `delete`, `activate`, `deactivate` |
| `field_name` | String (readonly) | Название измененного поля (для update действий) |
| `old_value` | String (readonly) | Старое значение поля (может быть JSON для сложных объектов) |
| `new_value` | String (readonly) | Новое значение поля (может быть JSON для сложных объектов) |
| `change_reason` | String (readonly) | Причина изменения (заполняется администратором при сохранении) |
| `created_at` | DateTime (readonly) | Дата и время изменения |

---

## Валидация данных

### Общие правила валидации

1. **Обязательные поля** должны быть заполнены перед сохранением
2. **Типы данных** должны соответствовать указанным в спецификации
3. **Диапазоны значений** должны соблюдаться (например, weight: 1-100)
4. **Уникальность** должна проверяться для полей, требующих уникальности (display_order)
5. **Сумма весов** должна равняться 100 для активных призов витрины
6. **Связи между сущностями** должны быть валидными (showcase_id существует, prize_id существует)

### Специфичные проверки

#### При сохранении конфигурации призов:
- Если изменяется `weight` или `is_active`, система должна проверить, что сумма весов всех активных призов = 100
- Если сумма не равна 100, показать предупреждение и предложить автоматическую корректировку
- При удалении приза система должна проверить, что останется минимум 8 активных призов

#### При изменении Pity Timer:
- Проверить, что выбранный `legendary_prize_id` является активным призом для витрины
- Предупредить, если Pity Timer отключается, что это может повлиять на пользовательский опыт

#### При привязке купонов:
- Проверить, что `offer_id` существует в системе магазина
- Проверить пересечение периодов действия (`valid_from`, `valid_until`)
- Предупредить о дублирующихся привязках для одного оффера

---

## Права доступа

### Роли администраторов

| Роль | Права |
|------|-------|
| **Super Admin** | Полный доступ ко всем разделам, включая удаление витрин и призов |
| **Content Manager** | Может редактировать призы, настройки Pity Timer, загружать иконки. Не может изменять привязки купонов |
| **Analyst** | Только просмотр статистики и аналитики. Не может вносить изменения |
| **Coupon Manager** | Может управлять привязками купонов к офферам. Не может изменять конфигурацию призов |

### Дополнительные ограничения

- Все изменения должны логироваться с указанием администратора
- Критические изменения (удаление витрины, изменение весов призов) требуют подтверждения от Super Admin
- Изменения конфигурации призов вступают в силу немедленно (без задержки)
- При изменении активной витрины система должна уведомить всех активных пользователей через WebSocket (опционально)

---

## UI/UX рекомендации

### Интерфейс редактирования призов

1. **Визуальное представление колеса**: Показывать превью колеса с текущими настройками в реальном времени
2. **Drag & Drop**: Позволить перетаскивать призы для изменения `display_order`
3. **Валидация в реальном времени**: Показывать предупреждения при изменении весов (сумма не равна 100)
4. **Предпросмотр иконок**: Отображать загруженные иконки сразу после загрузки
5. **Цветовой пикер**: Использовать современный color picker с предпросмотром цвета на колесе

### Интерфейс статистики

1. **Графики**: Визуализировать распределение призов, тренды спинов, активность пользователей
2. **Экспорт данных**: Возможность экспорта статистики в CSV/Excel
3. **Фильтры**: Расширенные фильтры по датам, витринам, пользователям
4. **Дашборд**: Главная страница с ключевыми метриками за последние 7/30 дней

---

## API для админ-панели

Админ-панель должна использовать следующие эндпоинты (описание в `API_SPECIFICATION.md`):

- `GET /admin/showcases` — список всех витрин
- `POST /admin/showcases` — создание витрины
- `PUT /admin/showcases/{id}` — обновление витрины
- `DELETE /admin/showcases/{id}` — удаление витрины
- `GET /admin/showcases/{id}/prizes` — список призов витрины
- `POST /admin/prizes` — создание приза
- `PUT /admin/prizes/{id}` — обновление приза
- `DELETE /admin/prizes/{id}` — удаление приза
- `PUT /admin/pity-config/{showcase_id}` — обновление Pity Timer
- `GET /admin/statistics` — получение статистики
- `GET /admin/audit-log` — история изменений

---

**Конец спецификации**

